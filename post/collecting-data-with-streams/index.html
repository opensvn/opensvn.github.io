<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用流收集数据 - 招财猫的博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="招财猫" /><meta name="description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： 1 2 3 4 5 6 7 8 9 10 Map&amp;lt;Currency, List&amp;lt;Transaction&amp;gt;&amp;gt; transactionsByCurrencies" /><meta name="keywords" content="Emacs, Cocos2d, Graphics" />






<meta name="generator" content="Hugo 0.70.0 with theme even" />


<link rel="canonical" href="https://gitop.cc/post/collecting-data-with-streams/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.78f8f17bab244b9ee62ad16480c9584d5fc2db06ae20681d1ca225cefd80767c.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="使用流收集数据" />
<meta property="og:description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： 1 2 3 4 5 6 7 8 9 10 Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gitop.cc/post/collecting-data-with-streams/" />
<meta property="article:published_time" content="2019-07-23T13:04:54+08:00" />
<meta property="article:modified_time" content="2019-07-23T13:04:54+08:00" />
<meta itemprop="name" content="使用流收集数据">
<meta itemprop="description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： 1 2 3 4 5 6 7 8 9 10 Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies">
<meta itemprop="datePublished" content="2019-07-23T13:04:54&#43;08:00" />
<meta itemprop="dateModified" content="2019-07-23T13:04:54&#43;08:00" />
<meta itemprop="wordCount" content="4250">



<meta itemprop="keywords" content="Java," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用流收集数据"/>
<meta name="twitter:description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： 1 2 3 4 5 6 7 8 9 10 Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">招财猫的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">招财猫的博客</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">使用流收集数据</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-07-23 </span>
        <div class="post-category">
            <a href="/categories/language/"> Language </a>
            </div>
          <span class="more-meta"> 约 4250 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#归纳总结">归纳总结</a>
      <ul>
        <li><a href="#查找最大和最小值">查找最大和最小值</a></li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#连接字符串">连接字符串</a></li>
        <li><a href="#通用归纳总结">通用归纳总结</a></li>
      </ul>
    </li>
    <li><a href="#分组">分组</a>
      <ul>
        <li><a href="#操作分组元素">操作分组元素</a></li>
        <li><a href="#多级分组">多级分组</a></li>
        <li><a href="#在子分组中收集数据">在子分组中收集数据</a></li>
      </ul>
    </li>
    <li><a href="#分区">分区</a>
      <ul>
        <li><a href="#advantages-of-partitioning">Advantages of partitioning</a></li>
        <li><a href="#将数字划分为素数和非素数">将数字划分为素数和非素数</a></li>
      </ul>
    </li>
    <li><a href="#collector接口">Collector接口</a>
      <ul>
        <li><a href="#理解collector接口声明的方法">理解Collector接口声明的方法</a></li>
      </ul>
    </li>
    <li><a href="#开发自己的收集器">开发自己的收集器</a>
      <ul>
        <li><a href="#只除质数">只除质数</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Currency</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;&gt;</span> <span class="n">transactionsByCurrencies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="n">Transaction</span> <span class="n">transaction</span> <span class="o">:</span> <span class="n">transactions</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Currency</span> <span class="n">currency</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="na">getCurrency</span><span class="o">();</span>
	<span class="n">List</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;</span> <span class="n">transactionsForCurrency</span> <span class="o">=</span> <span class="n">transactionsByCurrencies</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currency</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">transactionsForCurrency</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">transactionsForCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
		<span class="n">transactionsByCurrencies</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">currency</span><span class="o">,</span> <span class="n">transactionsForCurrency</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="n">transactionsForCurrency</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">transaction</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在Java 8之后，仅用一条语句就可以获得完全相同的结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Currency</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;&gt;</span> <span class="n">transactionsByCurrencies</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Transaction</span><span class="o">::</span><span class="n">getCurrency</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p>Collector接口提供了三个主要功能：</p>
<ul>
<li>
<p>将流中的元素汇总为一个值</p>
</li>
<li>
<p>将元素进行分组</p>
</li>
<li>
<p>将元素进行分区</p>
</li>
</ul>
<h2 id="归纳总结">归纳总结</h2>
<p>Collector接口（collect方法的参数）通常用于需要将流的元素重新组织到集合中的情况。但更一般的情况是，Collector接口可以用于将流中的所有元素组合成一个结果时。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">long</span> <span class="n">howManyDishes</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">counting</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以写成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">long</span> <span class="n">howManyDishes</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">count</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="查找最大和最小值">查找最大和最小值</h3>
<p>你可以使用<code>Collectors.maxBy</code> 和<code>Collectors.minBy</code> 计算流中的最大值和最小值。它们的参数是<code>Comparator</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="n">dishCaloriesComparator</span> <span class="o">=</span> <span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">);</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="n">mostCalorieDish</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">maxBy</span><span class="o">(</span><span class="n">dishCaloriesComparator</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="总结">总结</h3>
<p>Collectors类提供了用于求和的特定工厂方法<code>Collectors.summingInt</code>，其参数是<code>ToIntFunction</code>，并返回一个Collector。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">summingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Collectors.summingLong</code> 和<code>Collectors.summingDouble</code> 方法类似用于计算long和double。<code>Collectors.averagingInt</code> ，<code>averagingLong</code> 和<code>averagingDouble</code> 用于计算一组值的平均值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">double</span> <span class="n">avgCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">averagingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p>有时候你想要获取更多统计信息，可以使用<code>Collectors.summarizingInt</code>。这个Collector将所有信息收集到<code>IntSummaryStatistics</code>类里面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">IntSummaryStatistics</span> <span class="n">menuStatistics</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">summarizingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">));</span>
<span class="c1">// IntSummaryStatistics{count=9, sum=4300, min=120, average=477.777778, max=800}
</span></code></pre></td></tr></table>
</div>
</div><p>同样相应地有<code>summarizingLong</code>和<code>summarizingDouble</code>以及对应的类<code>LongSummaryStatistics</code>和<code>DoubleSummaryStatistics</code></p>
<h3 id="连接字符串">连接字符串</h3>
<p><code>Collectors.joining</code>将流中所有对象连接成一个字符串，调用每个对象的<code>toString</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">shortMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getName</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">joining</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Collectors.joining</code>的重载版本接受一个字符串用于间隔元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">shortMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getName</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">joining</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="通用归纳总结">通用归纳总结</h3>
<p>到目前为止，我们讨论的所有Collector实际上都是<code>Collectors.reducing</code>方法的简便版。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">reducing</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">,</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">));</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="n">mostCalorieDish</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">reducing</span><span class="o">((</span><span class="n">d1</span><span class="o">,</span> <span class="n">d2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">d1</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">d2</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">?</span> <span class="n">d1</span> <span class="o">:</span> <span class="n">d2</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p>比如前面用到的<code>counting</code>定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nf">counting</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">reducing</span><span class="o">(</span><span class="n">0L</span><span class="o">,</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">1L</span><span class="o">,</span> <span class="n">Long</span><span class="o">::</span><span class="n">sum</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>达到同样的效果，可以有多种方法，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">).</span><span class="na">reduce</span><span class="o">(</span><span class="n">Integer</span><span class="o">::</span><span class="n">sum</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
<span class="kt">int</span> <span class="n">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="分组">分组</h2>
<p>数据库的一个常见操作是根据一个或多个属性将数据分组。Java 8中使用<code>groupingBy</code>达到相同的效果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="n">dishesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p>但是并不总是可以将方法引用用作分类函数，因为你可能希望使用比简单属性访问器更复杂的方法进行分类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">CaloricLevel</span> <span class="o">{</span><span class="n">DIET</span><span class="o">,</span> <span class="n">NORMAL</span><span class="o">,</span> <span class="n">FAT</span><span class="o">}</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="n">dishesByCaloricLevel</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
    <span class="n">groupingBy</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">DIET</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">FAT</span><span class="o">;</span>
    <span class="o">}));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="操作分组元素">操作分组元素</h3>
<p>假设你要按类型分组菜肴并在每个分组过滤热量大于500的菜肴，你可能会这样做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="n">caloricDishesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">500</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p>打印<code>caloricDishesByType</code>得到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{OTHER=[french fries, pizza], MEAT=[pork, beef]}
</code></pre></td></tr></table>
</div>
</div><p>可以看到这个方法有一个问题，<code>FISH</code>分组不见了。为了解决这个问题，<code>Collectors.groupingBy </code>提供了一个重载的方法接受另一个Collector参数。如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="n">caloricDishesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">filtering</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">500</span><span class="o">,</span> <span class="n">toList</span><span class="o">())));</span>
</code></pre></td></tr></table>
</div>
</div><p><code>filtering </code>接受一个谓词过滤每个分组的元素，另外一个Collector用于重新分组过滤后的元素。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{OTHER=[french fries, pizza], MEAT=[pork, beef], FISH=[]}
</code></pre></td></tr></table>
</div>
</div><p>另一种常见的操作分组元素的方法是通过映射函数转换它们。<code>Collectors.mapping</code>接受一个Function和另一个Collector用于收集分组中被映射的元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">dishNamesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">mapping</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getName</span><span class="o">,</span> <span class="n">toList</span><span class="o">())));</span>
</code></pre></td></tr></table>
</div>
</div><p><code>groupingBy</code>还可以和<code>flatMapping</code>结合使用。假设我们有如下数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">dishTags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;pork&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;greasy&#34;</span><span class="o">,</span> <span class="s">&#34;salty&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;beef&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;salty&#34;</span><span class="o">,</span> <span class="s">&#34;roasted&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;chicken&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;fried&#34;</span><span class="o">,</span> <span class="s">&#34;crisp&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;french fries&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;greasy&#34;</span><span class="o">,</span> <span class="s">&#34;fried&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rice&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;light&#34;</span><span class="o">,</span> <span class="s">&#34;natural&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;season fruit&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;fresh&#34;</span><span class="o">,</span> <span class="s">&#34;natural&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;tasty&#34;</span><span class="o">,</span> <span class="s">&#34;salty&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;prawns&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;tasty&#34;</span><span class="o">,</span> <span class="s">&#34;roasted&#34;</span><span class="o">));</span>
<span class="n">dishTags</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;salmon&#34;</span><span class="o">,</span> <span class="n">asList</span><span class="o">(</span><span class="s">&#34;delicious&#34;</span><span class="o">,</span> <span class="s">&#34;fresh&#34;</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><p>假如我们想要获取各类菜肴的标签，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">dishNamesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">flatMapping</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="n">dishTags</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">stream</span><span class="o">(),</span> <span class="n">toSet</span><span class="o">())));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="多级分组">多级分组</h3>
<p>带两个参数的<code>Collectors.groupingBy</code>可以用来执行两级分组，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;&gt;</span> <span class="n">dishesByTypeCaloricLevel</span> <span class="o">=</span>
    <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
        <span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span>
            <span class="n">groupingBy</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">DIET</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">FAT</span><span class="o">;</span>
            <span class="o">})</span>
        <span class="o">)</span>
    <span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>多级分组操作可以扩展到任意层级，一个N级分组结果是一个N级Map。</p>
<h3 id="在子分组中收集数据">在子分组中收集数据</h3>
<p><code>groupingBy</code>的第二个参数可以是任意类型的Collector。比如<code>counting</code>用于计算每个分组的数量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">typesCount</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">counting</span><span class="o">()));</span>
</code></pre></td></tr></table>
</div>
</div><p>而且单个参数的<code>groupingBy(f)</code>实际上等价于<code>groupingBy(f, toList())</code>。再举一个例子，获取各类菜肴热量最高的菜：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="n">mostCaloricByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">maxBy</span><span class="o">(</span><span class="n">comparingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">))));</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="将收集器结果调整为不同的类型">将收集器结果调整为不同的类型</h4>
<p>要使收集器返回的结果调整为不同的类型，可以使用Collectors.collectingAndThen factory`返回的Collector，如下面所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Dish</span><span class="o">&gt;</span> <span class="n">mostCaloricByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span>
	<span class="n">collectingAndThen</span><span class="o">(</span><span class="n">maxBy</span><span class="o">(</span><span class="n">comparingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">)),</span> <span class="n">Optional</span><span class="o">::</span><span class="n">get</span><span class="o">)));</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="与groupingby一起使用的其他收集器示例">与groupingBy一起使用的其他收集器示例</h4>
<p>更一般地，传递给<code>groupingBy</code>方法第二个参数的收集器将用于对流中分类为同一组的所有元素执行进一步的归纳操作。比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">totalCaloriesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">summingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">)));</span>
</code></pre></td></tr></table>
</div>
</div><p>另外一个收集器是由<code>mapping</code>方法生成的。此方法接受两个参数：一个函数转换流中的元素，另一个收集器收集转换后的对象。如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="o">&gt;&gt;</span> <span class="n">caloricLevelsByType</span> <span class="o">=</span>
    <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
        <span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">mapping</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">DIET</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">FAT</span><span class="o">;</span>
            <span class="o">},</span> <span class="n">toSet</span><span class="o">())));</span>
</code></pre></td></tr></table>
</div>
</div><p>在上例中，我们不知道<code>toSet</code>会返回什么类型的Set。如果你想要返回指定的集合，可以是用<code>toCollection</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="o">&gt;&gt;</span> <span class="n">caloricLevelsByType</span> <span class="o">=</span>
    <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
        <span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">,</span> <span class="n">mapping</span><span class="o">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">DIET</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">dish</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="o">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="o">.</span><span class="na">FAT</span><span class="o">;</span>
            <span class="o">},</span> <span class="n">toCollection</span><span class="o">(</span><span class="n">HashSet</span><span class="o">::</span><span class="k">new</span><span class="o">))));</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="分区">分区</h2>
<p>分区是分组的一种特殊情况：使用一个称为分区函数的谓词作为分类函数。分区函数返回布尔值这一事实意味着生成的分组映射将使用布尔值作为键类型，因此最多可以有两个不同的组——一个为true，一个为false。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="n">partitionedMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">partitioningBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">isVegetarian</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="advantages-of-partitioning">Advantages of partitioning</h3>
<p>和分组一样，<code>partitioningBy</code>方法也有一个重载版本，可以向其传递第二个收集器，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;&gt;</span> <span class="n">vegetarianDishesByType</span> <span class="o">=</span>
    <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
        <span class="n">partitioningBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">isVegetarian</span><span class="o">,</span> <span class="n">groupingBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="o">)));</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">Dish</span><span class="o">&gt;</span> <span class="n">mostCaloricPartitionedByVegetarian</span> <span class="o">=</span>
    <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
        <span class="n">partitioningBy</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">isVegetarian</span><span class="o">,</span>
            <span class="n">collectingAndThen</span><span class="o">(</span><span class="n">maxBy</span><span class="o">(</span><span class="n">comparingInt</span><span class="o">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="o">)),</span>
                <span class="n">Optional</span><span class="o">::</span><span class="n">get</span><span class="o">)));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="将数字划分为素数和非素数">将数字划分为素数和非素数</h3>
<p>假设你想编写一个方法，接受一个整数n作为参数，并将前n个自然数划分为素数和非素数。但首先，你需要一个谓词判断一个整数是否是质数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">int</span> <span class="n">candidate</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">candidate</span><span class="o">).</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面是一个小小的优化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">int</span> <span class="n">candidate</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">candidateRoot</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span> <span class="n">candidate</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">candidateRoot</span><span class="o">).</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>现在就可以划分前n个整数是否是质数了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">partitionPrimes</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">n</span><span class="o">).</span><span class="na">boxed</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">partitioningBy</span><span class="o">(</span><span class="n">candidate</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">candidate</span><span class="o">)));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下表是<code>Collectors</code>类中主要的静态工厂方法：</p>
<table>
<thead>
<tr>
<th>工厂方法</th>
<th>返回类型</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>toList</td>
<td>List&lt;T&gt;</td>
<td>将流中的元素放入List</td>
</tr>
<tr>
<td>toSet</td>
<td>Set&lt;T&gt;</td>
<td>将流中的元素放入Set，去除重复元素</td>
</tr>
<tr>
<td>toCollection</td>
<td>Collection&lt;T&gt;</td>
<td>将流中的元素放入指定的集合</td>
</tr>
<tr>
<td>counting</td>
<td>Long</td>
<td>统计流中元素个数</td>
</tr>
<tr>
<td>summingInt</td>
<td>Integer</td>
<td>对流中元素的整形属性求和</td>
</tr>
<tr>
<td>averagingInt</td>
<td>Double</td>
<td>计算流中元素的整形属性的平均值</td>
</tr>
<tr>
<td>summarizingInt</td>
<td>IntSummaryStatistics</td>
<td>收集流中元素的整形属性的统计数据</td>
</tr>
<tr>
<td>joining</td>
<td>String</td>
<td>连接流中元素调用toString方法产生的字符串</td>
</tr>
<tr>
<td>maxBy</td>
<td>Optional&lt;T&gt;</td>
<td>根据指定的Comparator返回流中最大的元素或Optional.empty()</td>
</tr>
<tr>
<td>minBy</td>
<td>Optional&lt;T&gt;</td>
<td>根据指定的Comparator返回流中最小的元素或Optional.empty()</td>
</tr>
<tr>
<td>reducing</td>
<td>归纳操作产生的类型</td>
<td>使用BinaryOperator依次将流中元素合并为一个值</td>
</tr>
<tr>
<td>collectingAndThen</td>
<td>转换函数返回的类型</td>
<td>包装另一个收集器并对其结果应用转换函数</td>
</tr>
<tr>
<td>groupingBy</td>
<td>Map&lt;K, List&lt;T&gt;&gt;</td>
<td>基于流中元素的属性作为键值分组元素</td>
</tr>
<tr>
<td>partitioningBy</td>
<td>Map&lt;Boolean, List&lt;T&gt;&gt;</td>
<td>基于谓词对流中的元素分区</td>
</tr>
</tbody>
</table>
<h2 id="collector接口">Collector接口</h2>
<p>Collector接口声明的方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">supplier</span><span class="o">();</span>
    <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="o">();</span>
    <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="nf">finisher</span><span class="o">();</span>
    <span class="n">BinaryOperator</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">combiner</span><span class="o">();</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Characteristics</span><span class="o">&gt;</span> <span class="nf">characteristics</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中：</p>
<ul>
<li>T是要被收集的流中元素的类型</li>
<li>A是累加器的类型，在收集过程中，收集部分结果的对象。</li>
<li>R是结果类型</li>
</ul>
<p>比如你可以实现一个类<code>ToListCollector&lt;T&gt;</code> 将<code>Stream&lt;T&gt;</code>中所有的元素收集到<code>List&lt;T&gt;</code>中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ToListCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="理解collector接口声明的方法">理解Collector接口声明的方法</h3>
<h4 id="supplier方法">supplier方法</h4>
<p><code>supplier</code>方法必须返回一个空的累加器，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">supplier</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以使用构造器引用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">supplier</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">ArrayList</span><span class="o">::</span><span class="k">new</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="accumulator方法">accumulator方法</h4>
<p><code>accumulator </code>方法返回一个执行归纳操作的函数。这个函数带2个参数，一个是累加器，一个是流中第n个元素，并返回void，因为累加器被就地修改。比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">item</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以使用方法引用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">List</span><span class="o">::</span><span class="n">add</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="finisher方法">finisher方法</h4>
<p><code>finisher</code>方法返回一个在累加过程最后调用的函数，用于将累加器对象转换为最终结果，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">finisher</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下图为<code>collect</code>方法处理过程</p>
<p><img src="/img/2019/07/23/collect.png" alt="collect.png"></p>
<h4 id="combiner方法">combiner方法</h4>
<p><code>combiner</code>方法返回一个方法用于并行处理时将流中不同的子部分元素合并起来，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BinaryOperator</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">combiner</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">list1</span><span class="o">,</span> <span class="n">list2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">list1</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">list2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">list1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="characteristics方法">characteristics方法</h4>
<p><code>characteristics</code>方法返回<code>Characteristics</code>集合，定义了收集器的行为。特别是提示是否可以并行处理以及哪些优化可行。<code>Characteristics</code>是一个枚举：</p>
<ul>
<li>UNORDERED：归纳的结果不受遍历和累加流中元素的顺序的影响</li>
<li>CONCURRENT：累加方法可以被多个线程并发调用，收集器可以在流上执行并行归纳。</li>
<li>IDENTITY_FINISH：<code>finisher</code>方法返回的结果是累加器本身，这意味着累加器A到结果R的类型转换不需要检查。</li>
</ul>
<h4 id="collect方法重载版本">collect方法重载版本</h4>
<p>对于<code>IDENTITY_FINISH</code>类型的收集操作，可以不需要实现<code>Collector</code>接口就能自定义收集操作。<code>collect</code>方法有一个重载版本接受3个参数——<code>supplier</code>，<code>accumulator</code>，<code>combiner</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="n">dishes</span> <span class="o">=</span> <span class="n">menuStream</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">::</span><span class="k">new</span><span class="o">,</span> <span class="n">List</span><span class="o">::</span><span class="n">add</span><span class="o">,</span> <span class="n">List</span><span class="o">::</span><span class="n">addAll</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="开发自己的收集器">开发自己的收集器</h2>
<h3 id="只除质数">只除质数</h3>
<p>判断一个数是否是质数，只需将这个数除以比它小的质数即可，不用每一个数都去测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">primes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">candidate</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">primes</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">primes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">candidate</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">candidateRoot</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span> <span class="n">candidate</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">primes</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">takeWhile</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">candidateRoot</span><span class="o">)</span>
        <span class="o">.</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="定义收集器类">定义收集器类</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrimeNumbersCollector</span> <span class="kd">implements</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="实现归纳过程">实现归纳过程</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">supplier</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{{</span>
        <span class="n">put</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;());</span>
        <span class="n">put</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;());</span>
    <span class="o">}};</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">acc</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">candidate</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">isPrime</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="n">candidate</span><span class="o">))</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">candidate</span><span class="o">);</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="尽可能并行收集">尽可能并行收集</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BinaryOperator</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">combiner</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">map1</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">map2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">map1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">addAll</span><span class="o">(</span><span class="n">map2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
        <span class="n">map1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">addAll</span><span class="o">(</span><span class="n">map2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">map1</span><span class="o">;</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="最后两个方法">最后两个方法</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">finisher</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Characteristics</span><span class="o">&gt;</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">EnumSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">IDENTITY_FINISH</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>现在可以使用这个自定义的收集器分区质数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">partitionPrimesWithCustomCollector</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">n</span><span class="o">).</span><span class="na">boxed</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">PrimeNumbersCollector</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以使用<code>collect</code>接受3个参数的重载版本，但是这样可读性变差了，而且代码也不能复用了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">partitionPrimesWithCustomCollector</span> <span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">n</span><span class="o">).</span><span class="na">boxed</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
        <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{{</span>
            <span class="n">put</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;());</span>
            <span class="n">put</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;());</span>
        <span class="o">}},</span>
        <span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">candidate</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">isPrime</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="n">candidate</span><span class="o">))</span>
                <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">candidate</span><span class="o">);</span>
        <span class="o">},</span>
        <span class="o">(</span><span class="n">map1</span><span class="o">,</span> <span class="n">map2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">map1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">addAll</span><span class="o">(</span><span class="n">map2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
            <span class="n">map1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">addAll</span><span class="o">(</span><span class="n">map2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
        <span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">招财猫</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-07-23
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-reward.png">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-reward.png">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">Java</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/parallel-data-processing-and-performance/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">并行数据处理和性能</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/working-with-streams/">
            <span class="next-text nav-default">使用流</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  <span id="/post/collecting-data-with-streams/" class="leancloud_visitors" data-flag-title="使用流收集数据">
		<span class="post-meta-item-text">文章阅读量 </span>
		<span class="leancloud-visitors-count">0</span>
		<p></p>
	  </span>
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'nTlkWW6BFHR3ekmRDf9ragQd-gzGzoHsz',
        appKey: 'aGlzQgiAeX7JBeHOTXK9SgpC',
        notify:  false ,
        verify:  false ,
        avatar:'mm',
        placeholder: '说点什么吧...',
        visitor:  true 
    });
  </script>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://github.com/opensvn" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/opensvn" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://gitop.cc/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">招财猫</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>








</body>
</html>
