<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="使用流收集数据">
<meta itemprop="description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies = new HashMap&lt;&gt;(); for (Transaction transaction : transactions) { Currency">


<meta itemprop="datePublished" content="2019-07-23T13:04:54&#43;08:00" />
<meta itemprop="dateModified" content="2019-07-23T13:04:54&#43;08:00" />
<meta itemprop="wordCount" content="4081">



<meta itemprop="keywords" content="Java," />
<meta property="og:title" content="使用流收集数据" />
<meta property="og:description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies = new HashMap&lt;&gt;(); for (Transaction transaction : transactions) { Currency" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://gitop.cc/posts/collecting-data-with-streams/" />
<meta property="article:published_time" content="2019-07-23T13:04:54+08:00" />
<meta property="article:modified_time" content="2019-07-23T13:04:54+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用流收集数据"/>
<meta name="twitter:description" content="假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示： Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies = new HashMap&lt;&gt;(); for (Transaction transaction : transactions) { Currency"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>使用流收集数据</title>
	<link rel="stylesheet" href="http://gitop.cc/css/style.min.574d8c6248cc82ef15f1ad92df37a0e749a3d11c6d81e64dcc2ed1f90be506cc.css" integrity="sha256-V02MYkjMgu8V8a2S3zeg50mj0RxtgeZNzC7R+QvlBsw=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="http://gitop.cc">静心</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="http://gitop.cc/posts/">Posts</a>
				<a href="http://gitop.cc/tags/">Tags</a>
				<a href="http://gitop.cc/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://github.com/opensvn" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="http://gitop.cc/posts/">Posts</a></li>
			<li><a href="http://gitop.cc/tags/">Tags</a></li>
			<li><a href="http://gitop.cc/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jul 23, 2019</span></div>
				<h1>使用流收集数据</h1>
			</header>
			<div class="content">
				

<p>假设有一个事务列表，你希望根据货币对它们进行分组。在Java 8之前，即使是这样一个简单的例子也很难实现，如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Currency</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;&gt;</span> <span class="nf">transactionsByCurrencies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="n">Transaction</span> <span class="nf">transaction</span> <span class="o">:</span> <span class="n">transactions</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Currency</span> <span class="nf">currency</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">.</span><span class="na">getCurrency</span><span class="p">();</span>
	<span class="n">List</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;</span> <span class="nf">transactionsForCurrency</span> <span class="o">=</span> <span class="n">transactionsByCurrencies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transactionsForCurrency</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">transactionsForCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
		<span class="n">transactionsByCurrencies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">transactionsForCurrency</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">transactionsForCurrency</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>在Java 8之后，仅用一条语句就可以获得完全相同的结果：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Currency</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;&gt;</span> <span class="nf">transactionsByCurrencies</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Transaction</span><span class="o">::</span><span class="n">getCurrency</span><span class="p">));</span></code></pre></div>
<p>Collector接口提供了三个主要功能：</p>

<ul>
<li>将流中的元素汇总为一个值</li>

<li><p>将元素进行分组</p></li>

<li><p>将元素进行分区</p></li>
</ul>

<h2 id="归纳总结">归纳总结<a href="#归纳总结" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>Collector接口（collect方法的参数）通常用于需要将流的元素重新组织到集合中的情况。但更一般的情况是，Collector接口可以用于将流中的所有元素组合成一个结果时。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">long</span> <span class="nf">howManyDishes</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">counting</span><span class="p">());</span></code></pre></div>
<p>也可以写成</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">long</span> <span class="nf">howManyDishes</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">count</span><span class="p">();</span></code></pre></div>
<h3 id="查找最大和最小值">查找最大和最小值<a href="#查找最大和最小值" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>你可以使用<code>Collectors.maxBy</code> 和<code>Collectors.minBy</code> 计算流中的最大值和最小值。它们的参数是<code>Comparator</code></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="nf">dishCaloriesComparator</span> <span class="o">=</span> <span class="n">Comparator</span><span class="p">.</span><span class="na">comparingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">);</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="nf">mostCalorieDish</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">maxBy</span><span class="p">(</span><span class="n">dishCaloriesComparator</span><span class="p">));</span></code></pre></div>
<h3 id="总结">总结<a href="#总结" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>Collectors类提供了用于求和的特定工厂方法<code>Collectors.summingInt</code>，其参数是<code>ToIntFunction</code>，并返回一个Collector。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="nf">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">summingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">));</span></code></pre></div>
<p><code>Collectors.summingLong</code> 和<code>Collectors.summingDouble</code> 方法类似用于计算long和double。<code>Collectors.averagingInt</code> ，<code>averagingLong</code> 和<code>averagingDouble</code> 用于计算一组值的平均值。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">double</span> <span class="nf">avgCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">averagingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">));</span></code></pre></div>
<p>有时候你想要获取更多统计信息，可以使用<code>Collectors.summarizingInt</code>。这个Collector将所有信息收集到<code>IntSummaryStatistics</code>类里面。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">IntSummaryStatistics</span> <span class="nf">menuStatistics</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">summarizingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">));</span>
<span class="o">//</span> <span class="n">IntSummaryStatistics</span><span class="p">{</span><span class="n">count</span><span class="o">=</span><span class="n">9</span><span class="p">,</span> <span class="n">sum</span><span class="o">=</span><span class="n">4300</span><span class="p">,</span> <span class="n">min</span><span class="o">=</span><span class="n">120</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="n">477</span><span class="p">.</span><span class="na">777778</span><span class="p">,</span> <span class="n">max</span><span class="o">=</span><span class="n">800</span><span class="p">}</span></code></pre></div>
<p>同样相应地有<code>summarizingLong</code>和<code>summarizingDouble</code>以及对应的类<code>LongSummaryStatistics</code>和<code>DoubleSummaryStatistics</code></p>

<h3 id="连接字符串">连接字符串<a href="#连接字符串" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p><code>Collectors.joining</code>将流中所有对象连接成一个字符串，调用每个对象的<code>toString</code>方法。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="nf">shortMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getName</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">joining</span><span class="p">());</span></code></pre></div>
<p><code>Collectors.joining</code>的重载版本接受一个字符串用于间隔元素：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="nf">shortMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getName</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">joining</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">));</span></code></pre></div>
<h3 id="通用归纳总结">通用归纳总结<a href="#通用归纳总结" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>到目前为止，我们讨论的所有Collector实际上都是<code>Collectors.reducing</code>方法的简便版。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="nf">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">reducing</span><span class="p">(</span><span class="n">0</span><span class="p">,</span> <span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="nf">mostCalorieDish</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">reducing</span><span class="p">((</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">d1</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">d2</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">?</span> <span class="n">d1</span> <span class="o">:</span> <span class="n">d2</span><span class="p">));</span></code></pre></div>
<p>比如前面用到的<code>counting</code>定义如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nf">counting</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">reducing</span><span class="p">(</span><span class="n">0L</span><span class="p">,</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">1L</span><span class="p">,</span> <span class="n">Long</span><span class="o">::</span><span class="n">sum</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>达到同样的效果，可以有多种方法，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="nf">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">).</span><span class="na">reduce</span><span class="p">(</span><span class="n">Integer</span><span class="o">::</span><span class="n">sum</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">totalCalories</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">mapToInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">).</span><span class="na">sum</span><span class="p">();</span></code></pre></div>
<h2 id="分组">分组<a href="#分组" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>数据库的一个常见操作是根据一个或多个属性将数据分组。Java 8中使用<code>groupingBy</code>达到相同的效果：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="nf">dishesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">));</span></code></pre></div>
<p>但是并不总是可以将方法引用用作分类函数，因为你可能希望使用比简单属性访问器更复杂的方法进行分类。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">enum</span> <span class="n">CaloricLevel</span> <span class="p">{</span><span class="n">DIET</span><span class="p">,</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">FAT</span><span class="p">}</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="nf">dishesByCaloricLevel</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
    <span class="n">groupingBy</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">DIET</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">FAT</span><span class="p">;</span>
    <span class="p">}));</span></code></pre></div>
<h3 id="操作分组元素">操作分组元素<a href="#操作分组元素" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>假设你要按类型分组菜肴并在每个分组过滤热量大于500的菜肴，你可能会这样做：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="nf">caloricDishesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">500</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">));</span></code></pre></div>
<p>打印<code>caloricDishesByType</code>得到：</p>

<pre><code>{OTHER=[french fries, pizza], MEAT=[pork, beef]}
</code></pre>

<p>可以看到这个方法有一个问题，<code>FISH</code>分组不见了。为了解决这个问题，<code>Collectors.groupingBy</code>提供了一个重载的方法接受另一个Collector参数。如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="nf">caloricDishesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">filtering</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">500</span><span class="p">,</span> <span class="n">toList</span><span class="p">())));</span></code></pre></div>
<p><code>filtering</code>接受一个谓词过滤每个分组的元素，另外一个Collector用于重新分组过滤后的元素。</p>

<pre><code>{OTHER=[french fries, pizza], MEAT=[pork, beef], FISH=[]}
</code></pre>

<p>另一种常见的操作分组元素的方法是通过映射函数转换它们。<code>Collectors.mapping</code>接受一个Function和另一个Collector用于收集分组中被映射的元素：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">dishNamesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">mapping</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getName</span><span class="p">,</span> <span class="n">toList</span><span class="p">())));</span></code></pre></div>
<p><code>groupingBy</code>还可以和<code>flatMapping</code>结合使用。假设我们有如下数据：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">dishTags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;pork&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;greasy&#34;</span><span class="p">,</span> <span class="s">&#34;salty&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;beef&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;salty&#34;</span><span class="p">,</span> <span class="s">&#34;roasted&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;chicken&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;fried&#34;</span><span class="p">,</span> <span class="s">&#34;crisp&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;french fries&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;greasy&#34;</span><span class="p">,</span> <span class="s">&#34;fried&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;rice&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;light&#34;</span><span class="p">,</span> <span class="s">&#34;natural&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;season fruit&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;fresh&#34;</span><span class="p">,</span> <span class="s">&#34;natural&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;pizza&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;tasty&#34;</span><span class="p">,</span> <span class="s">&#34;salty&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;prawns&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;tasty&#34;</span><span class="p">,</span> <span class="s">&#34;roasted&#34;</span><span class="p">));</span>
<span class="n">dishTags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;salmon&#34;</span><span class="p">,</span> <span class="n">asList</span><span class="p">(</span><span class="s">&#34;delicious&#34;</span><span class="p">,</span> <span class="s">&#34;fresh&#34;</span><span class="p">));</span></code></pre></div>
<p>假如我们想要获取各类菜肴的标签，如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">dishNamesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">flatMapping</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="n">dishTags</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getName</span><span class="p">()).</span><span class="na">stream</span><span class="p">(),</span> <span class="n">toSet</span><span class="p">())));</span></code></pre></div>
<h3 id="多级分组">多级分组<a href="#多级分组" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>带两个参数的<code>Collectors.groupingBy</code>可以用来执行两级分组，如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">dishesByTypeCaloricLevel</span> <span class="o">=</span>
    <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
        <span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span>
            <span class="n">groupingBy</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">DIET</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">FAT</span><span class="p">;</span>
            <span class="p">})</span>
        <span class="p">)</span>
    <span class="p">);</span></code></pre></div>
<p>多级分组操作可以扩展到任意层级，一个N级分组结果是一个N级Map。</p>

<h3 id="在子分组中收集数据">在子分组中收集数据<a href="#在子分组中收集数据" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p><code>groupingBy</code>的第二个参数可以是任意类型的Collector。比如<code>counting</code>用于计算每个分组的数量：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nf">typesCount</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">counting</span><span class="p">()));</span></code></pre></div>
<p>而且单个参数的<code>groupingBy(f)</code>实际上等价于<code>groupingBy(f, toList())</code>。再举一个例子，获取各类菜肴热量最高的菜：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="nf">mostCaloricByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">maxBy</span><span class="p">(</span><span class="n">comparingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">))));</span></code></pre></div>
<h4 id="将收集器结果调整为不同的类型">将收集器结果调整为不同的类型<a href="#将收集器结果调整为不同的类型" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p>要使收集器返回的结果调整为不同的类型，可以使用Collectors.collectingAndThen factory`返回的Collector，如下面所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Dish</span><span class="o">&gt;</span> <span class="nf">mostCaloricByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span>
	<span class="n">collectingAndThen</span><span class="p">(</span><span class="n">maxBy</span><span class="p">(</span><span class="n">comparingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">)),</span> <span class="n">Optional</span><span class="o">::</span><span class="n">get</span><span class="p">)));</span></code></pre></div>
<h4 id="与groupingby一起使用的其他收集器示例">与groupingBy一起使用的其他收集器示例<a href="#与groupingby一起使用的其他收集器示例" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p>更一般地，传递给<code>groupingBy</code>方法第二个参数的收集器将用于对流中分类为同一组的所有元素执行进一步的归纳操作。比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">totalCaloriesByType</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">summingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">)));</span></code></pre></div>
<p>另外一个收集器是由<code>mapping</code>方法生成的。此方法接受两个参数：一个函数转换流中的元素，另一个收集器收集转换后的对象。如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="o">&gt;&gt;</span> <span class="nf">caloricLevelsByType</span> <span class="o">=</span>
    <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
        <span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">mapping</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">DIET</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">FAT</span><span class="p">;</span>
            <span class="p">},</span> <span class="n">toSet</span><span class="p">())));</span></code></pre></div>
<p>在上例中，我们不知道<code>toSet</code>会返回什么类型的Set。如果你想要返回指定的集合，可以是用<code>toCollection</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">CaloricLevel</span><span class="o">&gt;&gt;</span> <span class="nf">caloricLevelsByType</span> <span class="o">=</span>
    <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
        <span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">,</span> <span class="n">mapping</span><span class="p">(</span><span class="n">dish</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">400</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">DIET</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dish</span><span class="p">.</span><span class="na">getCalories</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">700</span><span class="p">)</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">CaloricLevel</span><span class="p">.</span><span class="na">FAT</span><span class="p">;</span>
            <span class="p">},</span> <span class="n">toCollection</span><span class="p">(</span><span class="n">HashSet</span><span class="o">::</span><span class="k">new</span><span class="p">))));</span></code></pre></div>
<h2 id="分区">分区<a href="#分区" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>分区是分组的一种特殊情况：使用一个称为分区函数的谓词作为分类函数。分区函数返回布尔值这一事实意味着生成的分组映射将使用布尔值作为键类型，因此最多可以有两个不同的组——一个为true，一个为false。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;</span> <span class="nf">partitionedMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">partitioningBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">isVegetarian</span><span class="p">));</span></code></pre></div>
<h3 id="advantages-of-partitioning">Advantages of partitioning<a href="#advantages-of-partitioning" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>和分组一样，<code>partitioningBy</code>方法也有一个重载版本，可以向其传递第二个收集器，如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Dish</span><span class="p">.</span><span class="na">Type</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">vegetarianDishesByType</span> <span class="o">=</span>
    <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
        <span class="n">partitioningBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">isVegetarian</span><span class="p">,</span> <span class="n">groupingBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getType</span><span class="p">)));</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">Dish</span><span class="o">&gt;</span> <span class="nf">mostCaloricPartitionedByVegetarian</span> <span class="o">=</span>
    <span class="n">menu</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
        <span class="n">partitioningBy</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">isVegetarian</span><span class="p">,</span>
            <span class="n">collectingAndThen</span><span class="p">(</span><span class="n">maxBy</span><span class="p">(</span><span class="n">comparingInt</span><span class="p">(</span><span class="n">Dish</span><span class="o">::</span><span class="n">getCalories</span><span class="p">)),</span>
                <span class="n">Optional</span><span class="o">::</span><span class="n">get</span><span class="p">)));</span></code></pre></div>
<h3 id="将数字划分为素数和非素数">将数字划分为素数和非素数<a href="#将数字划分为素数和非素数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>假设你想编写一个方法，接受一个整数n作为参数，并将前n个自然数划分为素数和非素数。但首先，你需要一个谓词判断一个整数是否是质数：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">boolean</span> <span class="n">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="nf">candidate</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="n">2</span><span class="p">,</span> <span class="n">candidate</span><span class="p">).</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>下面是一个小小的优化：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">boolean</span> <span class="n">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="nf">candidate</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="nf">candidateRoot</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">candidate</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="n">2</span><span class="p">,</span> <span class="n">candidateRoot</span><span class="p">).</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>现在就可以划分前n个整数是否是质数了：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">partitionPrimes</span><span class="p">(</span><span class="kt">int</span> <span class="nf">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="n">2</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="na">boxed</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">partitioningBy</span><span class="p">(</span><span class="n">candidate</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">candidate</span><span class="p">)));</span>
<span class="p">}</span></code></pre></div>
<p>下表是<code>Collectors</code>类中主要的静态工厂方法：</p>

<table>
<thead>
<tr>
<th>工厂方法</th>
<th>返回类型</th>
<th>用途</th>
</tr>
</thead>

<tbody>
<tr>
<td>toList</td>
<td>List&lt;T&gt;</td>
<td>将流中的元素放入List</td>
</tr>

<tr>
<td>toSet</td>
<td>Set&lt;T&gt;</td>
<td>将流中的元素放入Set，去除重复元素</td>
</tr>

<tr>
<td>toCollection</td>
<td>Collection&lt;T&gt;</td>
<td>将流中的元素放入指定的集合</td>
</tr>

<tr>
<td>counting</td>
<td>Long</td>
<td>统计流中元素个数</td>
</tr>

<tr>
<td>summingInt</td>
<td>Integer</td>
<td>对流中元素的整形属性求和</td>
</tr>

<tr>
<td>averagingInt</td>
<td>Double</td>
<td>计算流中元素的整形属性的平均值</td>
</tr>

<tr>
<td>summarizingInt</td>
<td>IntSummaryStatistics</td>
<td>收集流中元素的整形属性的统计数据</td>
</tr>

<tr>
<td>joining</td>
<td>String</td>
<td>连接流中元素调用toString方法产生的字符串</td>
</tr>

<tr>
<td>maxBy</td>
<td>Optional&lt;T&gt;</td>
<td>根据指定的Comparator返回流中最大的元素或Optional.empty()</td>
</tr>

<tr>
<td>minBy</td>
<td>Optional&lt;T&gt;</td>
<td>根据指定的Comparator返回流中最小的元素或Optional.empty()</td>
</tr>

<tr>
<td>reducing</td>
<td>归纳操作产生的类型</td>
<td>使用BinaryOperator依次将流中元素合并为一个值</td>
</tr>

<tr>
<td>collectingAndThen</td>
<td>转换函数返回的类型</td>
<td>包装另一个收集器并对其结果应用转换函数</td>
</tr>

<tr>
<td>groupingBy</td>
<td>Map&lt;K, List&lt;T&gt;&gt;</td>
<td>基于流中元素的属性作为键值分组元素</td>
</tr>

<tr>
<td>partitioningBy</td>
<td>Map&lt;Boolean, List&lt;T&gt;&gt;</td>
<td>基于谓词对流中的元素分区</td>
</tr>
</tbody>
</table>

<h2 id="collector接口">Collector接口<a href="#collector接口" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>Collector接口声明的方法如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">interface</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">supplier</span><span class="p">();</span>
    <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="p">();</span>
    <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="nf">finisher</span><span class="p">();</span>
    <span class="n">BinaryOperator</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">combiner</span><span class="p">();</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Characteristics</span><span class="o">&gt;</span> <span class="nf">characteristics</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>
<p>其中：</p>

<ul>
<li>T是要被收集的流中元素的类型</li>
<li>A是累加器的类型，在收集过程中，收集部分结果的对象。</li>
<li>R是结果类型</li>
</ul>

<p>比如你可以实现一个类<code>ToListCollector&lt;T&gt;</code> 将<code>Stream&lt;T&gt;</code>中所有的元素收集到<code>List&lt;T&gt;</code>中</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">ToListCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">implements</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span></code></pre></div>
<h3 id="理解collector接口声明的方法">理解Collector接口声明的方法<a href="#理解collector接口声明的方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<h4 id="supplier方法">supplier方法<a href="#supplier方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p><code>supplier</code>方法必须返回一个空的累加器，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Supplier</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">supplier</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>
<p>也可以使用构造器引用：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Supplier</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">supplier</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">ArrayList</span><span class="o">::</span><span class="k">new</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<h4 id="accumulator方法">accumulator方法<a href="#accumulator方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p><code>accumulator</code>方法返回一个执行归纳操作的函数。这个函数带2个参数，一个是累加器，一个是流中第n个元素，并返回void，因为累加器被就地修改。比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">BiConsumer</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>也可以使用方法引用：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">BiConsumer</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">List</span><span class="o">::</span><span class="n">add</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<h4 id="finisher方法">finisher方法<a href="#finisher方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p><code>finisher</code>方法返回一个在累加过程最后调用的函数，用于将累加器对象转换为最终结果，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Function</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">finisher</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">Function</span><span class="p">.</span><span class="na">identity</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>
<p>下图为<code>collect</code>方法处理过程</p>

<p><img src="/static/images/2019/07/23/collect.png" alt="collect.png" /></p>

<h4 id="combiner方法">combiner方法<a href="#combiner方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p><code>combiner</code>方法返回一个方法用于并行处理时将流中不同的子部分元素合并起来，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">BinaryOperator</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">combiner</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">list1</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">list2</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">list1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h4 id="characteristics方法">characteristics方法<a href="#characteristics方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p><code>characteristics</code>方法返回<code>Characteristics</code>集合，定义了收集器的行为。特别是提示是否可以并行处理以及哪些优化可行。<code>Characteristics</code>是一个枚举：</p>

<ul>
<li>UNORDERED：归纳的结果不受遍历和累加流中元素的顺序的影响</li>
<li>CONCURRENT：累加方法可以被多个线程并发调用，收集器可以在流上执行并行归纳。</li>
<li>IDENTITY_FINISH：<code>finisher</code>方法返回的结果是累加器本身，这意味着累加器A到结果R的类型转换不需要检查。</li>
</ul>

<h4 id="collect方法重载版本">collect方法重载版本<a href="#collect方法重载版本" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>

<p>对于<code>IDENTITY_FINISH</code>类型的收集操作，可以不需要实现<code>Collector</code>接口就能自定义收集操作。<code>collect</code>方法有一个重载版本接受3个参数——<code>supplier</code>，<code>accumulator</code>，<code>combiner</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="nf">dishes</span> <span class="o">=</span> <span class="n">menuStream</span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">ArrayList</span><span class="o">::</span><span class="k">new</span><span class="p">,</span> <span class="n">List</span><span class="o">::</span><span class="n">add</span><span class="p">,</span> <span class="n">List</span><span class="o">::</span><span class="n">addAll</span><span class="p">);</span></code></pre></div>
<h2 id="开发自己的收集器">开发自己的收集器<a href="#开发自己的收集器" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<h3 id="只除质数">只除质数<a href="#只除质数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>判断一个数是否是质数，只需将这个数除以比它小的质数即可，不用每一个数都去测试</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">primes</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">candidate</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">primes</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="nf">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">primes</span><span class="p">,</span> <span class="kt">int</span> <span class="nf">candidate</span><span class="p">){</span>
    <span class="kt">int</span> <span class="nf">candidateRoot</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">candidate</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">primes</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
        <span class="p">.</span><span class="na">takeWhile</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">candidateRoot</span><span class="p">)</span>
        <span class="p">.</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">candidate</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="n">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<h4 id="定义收集器类">定义收集器类<a href="#定义收集器类" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">PrimeNumbersCollector</span> <span class="nf">implements</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span></code></pre></div>
<h4 id="实现归纳过程">实现归纳过程<a href="#实现归纳过程" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Supplier</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">supplier</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{{</span>
        <span class="n">put</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">());</span>
        <span class="n">put</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">());</span>
    <span class="p">}};</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="nf">BiConsumer</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">accumulator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">acc</span><span class="p">,</span> <span class="n">Integer</span> <span class="nf">candidate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">acc</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">isPrime</span><span class="p">(</span><span class="n">acc</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span> <span class="n">candidate</span><span class="p">))</span>
            <span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div>
<h4 id="尽可能并行收集">尽可能并行收集<a href="#尽可能并行收集" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">BinaryOperator</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">combiner</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">map1</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">map2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">map1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="na">addAll</span><span class="p">(</span><span class="n">map2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
        <span class="n">map1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">false</span><span class="p">).</span><span class="na">addAll</span><span class="p">(</span><span class="n">map2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">map1</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div>
<h4 id="最后两个方法">最后两个方法<a href="#最后两个方法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Function</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">finisher</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Function</span><span class="p">.</span><span class="na">identity</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="nf">Set</span><span class="o">&lt;</span><span class="n">Characteristics</span><span class="o">&gt;</span> <span class="nf">characteristics</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Collections</span><span class="p">.</span><span class="na">unmodifiableSet</span><span class="p">(</span><span class="n">EnumSet</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">IDENTITY_FINISH</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>
<p>现在可以使用这个自定义的收集器分区质数：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">partitionPrimesWithCustomCollector</span><span class="p">(</span><span class="kt">int</span> <span class="nf">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="n">2</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="na">boxed</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="k">new</span> <span class="n">PrimeNumbersCollector</span><span class="p">());</span>
<span class="p">}</span></code></pre></div>
<p>也可以使用<code>collect</code>接受3个参数的重载版本，但是这样可读性变差了，而且代码也不能复用了。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">partitionPrimesWithCustomCollector</span> <span class="p">(</span><span class="kt">int</span> <span class="nf">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="n">2</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="na">boxed</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span>
        <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{{</span>
            <span class="n">put</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">());</span>
            <span class="n">put</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">());</span>
        <span class="p">}},</span>
        <span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">acc</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">isPrime</span><span class="p">(</span><span class="n">acc</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span> <span class="n">candidate</span><span class="p">))</span>
                <span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="p">(</span><span class="n">map1</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">map1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="na">addAll</span><span class="p">(</span><span class="n">map2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
            <span class="n">map1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">false</span><span class="p">).</span><span class="na">addAll</span><span class="p">(</span><span class="n">map2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
        <span class="p">});</span>
<span class="p">}</span></code></pre></div>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="http://gitop.cc/tags/java">Java</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>4081 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-07-23 13:04 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="http://gitop.cc/posts/parallel-data-processing-and-performance/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>并行数据处理和性能</span>
			</a>
			<a class="prev-post" href="http://gitop.cc/posts/working-with-streams/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>使用流</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="http://gitop.cc">gitop</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="http://gitop.cc/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="http://gitop.cc/js/main.min.35ccbf1cdceb91e4c64c06b5d009d6e2977fafe56beda7762febd4e67528d2ac.js" integrity="sha256-Ncy/HNzrkeTGTAa10AnW4pd/r+Vr7ad2L+vU5nUo0qw="></script>

</body>

</html>
